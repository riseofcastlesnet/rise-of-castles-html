<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rise of Castles - Detalhes da Pesquisa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .research-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .research-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
        }

        .research-info h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .research-season {
            background: rgba(255, 107, 53, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 107, 53, 0.5);
            display: inline-block;
        }

        .progress-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #cccccc;
            font-size: 0.9em;
        }

        .sub-research-grid {
            display: grid;
            gap: 20px;
        }

        .sub-research-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .sub-research-card:hover {
            border-color: #ffd700;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .sub-research-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sub-research-info h3 {
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .sub-research-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            border: 1px solid;
        }

        .tag.troop {
            background: rgba(100, 200, 255, 0.2);
            border-color: rgba(100, 200, 255, 0.5);
            color: #64c8ff;
        }

        .tag.attribute {
            background: rgba(255, 100, 100, 0.2);
            border-color: rgba(255, 100, 100, 0.5);
            color: #ff6464;
        }

        .tag.medal {
            background: rgba(255, 200, 100, 0.2);
            border-color: rgba(255, 200, 100, 0.5);
            color: #ffc864;
        }

        .tag.field {
            background: rgba(150, 255, 150, 0.2);
            border-color: rgba(150, 255, 150, 0.5);
            color: #96ff96;
        }

        .level-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .level-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .level-button:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .level-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-display {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            color: #ffd700;
            min-width: 80px;
            text-align: center;
        }

        .level-costs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .cost-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cost-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .cost-label {
            color: #cccccc;
            font-size: 0.9em;
        }

        .bonus-preview {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .bonus-preview h4 {
            color: #00ff88;
            margin-bottom: 10px;
        }

        .bonus-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .bonus-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bonus-item:last-child {
            border-bottom: none;
        }

        .save-button {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        .save-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .save-all-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .save-all-button {
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            border: none;
            color: white;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .save-all-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 215, 0, 0.5);
        }

        .login-warning {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            color: #ffd700;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #cccccc;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .research-title {
                flex-direction: column;
                text-align: center;
            }
            
            .sub-research-header {
                flex-direction: column;
            }
            
            .level-selector {
                flex-direction: column;
                gap: 10px;
            }
            
            .save-all-container {
                position: relative;
                bottom: auto;
                right: auto;
                text-align: center;
                margin-top: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="goBack()">
            ← Voltar para Pesquisas
        </button>

        <div id="loginWarning" class="login-warning" style="display: none;">
            ⚠️ Você precisa estar logado para salvar seu progresso. Faça login e tente novamente.
        </div>

        <div id="loadingMessage" class="loading">
            Carregando detalhes da pesquisa...
        </div>

        <div id="researchContent" style="display: none;">
            <div class="header">
                <div class="research-title">
                    <div class="research-icon" id="researchIcon">🔬</div>
                    <div class="research-info">
                        <h1 id="researchName">Nome da Pesquisa</h1>
                        <span class="research-season" id="researchSeason">Temporada</span>
                    </div>
                </div>

                <div class="progress-summary">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value" id="totalProgress">0%</div>
                            <div class="summary-label">Progresso Total</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalMedalsUsed">0</div>
                            <div class="summary-label">Medalhas Usadas</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalCombatPower">0</div>
                            <div class="summary-label">Poder de Combate</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalMedalsRemaining">0</div>
                            <div class="summary-label">Medalhas Restantes</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sub-research-grid" id="subResearchGrid">
                <!-- Subpesquisas serão inseridas aqui dinamicamente -->
            </div>
        </div>

        <div class="save-all-container">
            <button class="save-all-button" id="saveAllButton" onclick="saveAllProgress()" style="display: none;">
                💾 Salvar Todo Progresso
            </button>
        </div>
    </div>

    <script>
        let currentResearch = null;
        let currentUserId = null;
        let hasChanges = false;
        let progressData = {};

        // Configuração da comunicação com o Wix
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'USER_INFO') {
                currentUserId = event.data.userId;
                console.log('UserID recebido:', currentUserId);
                
                if (!currentUserId) {
                    document.getElementById('loginWarning').style.display = 'block';
                    document.getElementById('saveAllButton').style.display = 'none';
                } else {
                    document.getElementById('saveAllButton').style.display = 'flex';
                }
            }
            
            if (event.data && event.data.type === 'RESEARCH_ID') {
                const researchId = event.data.researchId;
                console.log('Research ID recebido:', researchId);
                loadResearchDetails(researchId);
            }
        });

        // Função para carregar detalhes da pesquisa
        async function loadResearchDetails(researchId) {
            try {
                const response = await fetch(`https://www.riseofcastles.net/_functions/progresso${currentUserId ? `?userId=${currentUserId}` : ''}`);
                const data = await response.json();
                
                if (data.pesquisas) {
                    currentResearch = data.pesquisas.find(r => r._id === researchId);
                    
                    if (currentResearch) {
                        displayResearchDetails();
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('researchContent').style.display = 'block';
                    } else {
                        document.getElementById('loadingMessage').innerHTML = 'Pesquisa não encontrada.';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                document.getElementById('loadingMessage').innerHTML = 'Erro ao carregar os detalhes da pesquisa.';
            }
        }

        // Função para exibir detalhes da pesquisa
        function displayResearchDetails() {
            if (!currentResearch) return;

            // Cabeçalho
            document.getElementById('researchIcon').textContent = currentResearch.photo || '🔬';
            document.getElementById('researchName').textContent = currentResearch.name;
            document.getElementById('researchSeason').textContent = currentResearch.season || 'Base';

            // Inicializar dados de progresso
            currentResearch.subPesquisas.forEach(sub => {
                progressData[sub._id] = sub.nivelAtual;
            });

            // Atualizar resumo
            updateProgressSummary();

            // Exibir subpesquisas
            displaySubResearches();
        }

        // Função para exibir subpesquisas
        function displaySubResearches() {
            const grid = document.getElementById('subResearchGrid');
            
            grid.innerHTML = currentResearch.subPesquisas.map(sub => {
                const currentLevel = progressData[sub._id] || 0;
                const currentCost = sub.custos.find(c => c.nivel === currentLevel + 1);
                
                return `
                    <div class="sub-research-card">
                        <div class="sub-research-header">
                            <div class="sub-research-info">
                                <h3>${sub.name}</h3>
                                <div class="sub-research-tags">
                                    <span class="tag troop">${sub.tipoTropa}</span>
                                    <span class="tag attribute">${sub.atributo}</span>
                                    ${sub.tipoMedalha ? `<span class="tag medal">${sub.tipoMedalha}</span>` : ''}
                                    ${sub.campoUse ? `<span class="tag field">${sub.campoUse}</span>` : ''}
                                </div>
                            </div>
                        </div>

                        <div class="level-selector">
                            <span>Nível:</span>
                            <div class="level-input">
                                <button class="level-button" onclick="changeLevel('${sub._id}', -1)" ${currentLevel <= 0 ? 'disabled' : ''}>
                                    -
                                </button>
                                <div class="level-display">${currentLevel}/${sub.nivelMax}</div>
                                <button class="level-button" onclick="changeLevel('${sub._id}', 1)" ${currentLevel >= sub.nivelMax ? 'disabled' : ''}>
                                    +
                                </button>
                            </div>
                        </div>

                        ${currentCost ? `
                            <div class="level-costs">
                                <div class="cost-item">
                                    <div class="cost-value">${currentCost.custoMedalhas}</div>
                                    <div class="cost-label">Medalhas para Próximo Nível</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-value">+${currentCost.bonusValor}</div>
                                    <div class="cost-label">${sub.atributo}</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-value">+${currentCost.combatPower}</div>
                                    <div class="cost-label">Poder de Combate</div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="bonus-preview">
                            <h4>Bônus Atual Total:</h4>
                            <div class="bonus-list">
                                <div class="bonus-item">
                                    <span>${sub.atributo} (${sub.tipoTropa})</span>
                                    <span>+${sub.custos.slice(0, currentLevel).reduce((sum, c) => sum + c.bonusValor, 0)}</span>
                                </div>
                                <div class="bonus-item">
                                    <span>Poder de Combate</span>
                                    <span>+${sub.custos.slice(0, currentLevel).reduce((sum, c) => sum + c.combatPower, 0)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Função para alterar nível
        function changeLevel(subId, delta) {
            const sub = currentResearch.subPesquisas.find(s => s._id === subId);
            if (!sub) return;

            const currentLevel = progressData[subId] || 0;
            const newLevel = Math.max(0, Math.min(sub.nivelMax, currentLevel + delta));
            
            if (newLevel !== currentLevel) {
                progressData[subId] = newLevel;
                hasChanges = true;
                updateProgressSummary();
                displaySubResearches();
            }
        }

        // Função para atualizar resumo de progresso
        function updateProgressSummary() {
            let totalLevels = 0;
            let maxLevels = 0;
            let totalMedalsUsed = 0;
            let totalCombatPower = 0;
            let totalMedalsRemaining = 0;

            currentResearch.subPesquisas.forEach(sub => {
                const currentLevel = progressData[sub._id] || 0;
                totalLevels += currentLevel;
                maxLevels += sub.nivelMax;

                // Calcular medalhas usadas e poder de combate atual
                for (let i = 1; i <= currentLevel; i++) {
                    const cost = sub.custos.find(c => c.nivel === i);
                    if (cost) {
                        totalMedalsUsed += cost.custoMedalhas;
                        totalCombatPower += cost.combatPower;
                    }
                }

                // Calcular medalhas restantes
                for (let i = currentLevel + 1; i <= sub.nivelMax; i++) {
                    const cost = sub.custos.find(c => c.nivel === i);
                    if (cost) {
                        totalMedalsRemaining += cost.custoMedalhas;
                    }
                }
            });

            const progressPercentage = maxLevels > 0 ? (totalLevels / maxLevels) * 100 : 0;

            document.getElementById('totalProgress').textContent = progressPercentage.toFixed(1) + '%';
            document.getElementById('totalMedalsUsed').textContent = totalMedalsUsed.toLocaleString();
            document.getElementById('totalCombatPower').textContent = totalCombatPower.toLocaleString();
            document.getElementById('totalMedalsRemaining').textContent = totalMedalsRemaining.toLocaleString();
        }

        // Função para salvar todo o progresso
        async function saveAllProgress() {
            if (!currentUserId) {
                alert('Você precisa estar logado para salvar o progresso.');
                return;
            }

            if (!hasChanges) {
                alert('Nenhuma alteração foi feita.');
                return;
            }

            const saveButton = document.getElementById('saveAllButton');
            saveButton.disabled = true;
            saveButton.innerHTML = '⏳ Salvando...';

            try {
                const promises = Object.entries(progressData).map(([subId, nivel]) => {
                    return fetch('https://www.riseofcastles.net/_functions/saveProgress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUserId,
                            subPesquisaId: subId,
                            nivelAtual: nivel
                        })
                    });
                });

                await Promise.all(promises);
                
                hasChanges = false;
                alert('Progresso salvo com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar progresso:', error);
                alert('Erro ao salvar o progresso. Tente novamente.');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '💾 Salvar Todo Progresso';
            }
        }

        // Função para voltar
        function goBack() {
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'NAVIGATE_BACK'
                }, '*');
            } else {
                window.history.back();
            }
        }

        // Simulação de recebimento de ID da pesquisa (para teste)
        setTimeout(() => {
            if (!currentResearch) {
                // Simular recebimento de ID para teste
                const urlParams = new URLSearchParams(window.location.search);
                const testResearchId = urlParams.get('researchId');
                if (testResearchId) {
                    loadResearchDetails(testResearchId);
                }
            }
        }, 2000);
    </script>
</body>
</html>
            